import os
import geopandas as gpd

BASE = os.path.dirname(os.path.dirname(__file__))
OUT = os.path.join(BASE, "output")

# خواندن همه فایل‌های ریسک
flood = gpd.read_file(os.path.join(OUT, "parcel_flood_risk.geojson"))
heat = gpd.read_file(os.path.join(OUT, "parcel_heat_risk.geojson"))
quake = gpd.read_file(os.path.join(OUT, "parcel_quake_risk.geojson"))
fire = gpd.read_file(os.path.join(OUT, "parcel_fire_prob.geojson"))

# ترکیب شاخص‌ها
g = flood.copy()
g["heat_risk"] = heat["heat_risk"]
g["risk_quake"] = quake["risk_quake"]
g["fire_prob"] = fire["fire_prob"]

# وزن‌دهی (قابل تنظیم)
weights = {
    "risk_flood": 0.3,
    "heat_risk": 0.25,
    "risk_quake": 0.25,
    "fire_prob": 0.2,
}

g["vulnerability"] = (
    g["risk_flood"] * weights["risk_flood"]
    + g["heat_risk"] * weights["heat_risk"]
    + g["risk_quake"] * weights["risk_quake"]
    + g["fire_prob"] * weights["fire_prob"]
)

out_fp = os.path.join(OUT, "parcel_vulnerability.geojson")
g.to_file(out_fp, driver="GeoJSON")
print("✅ Saved:", out_fp)